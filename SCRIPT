local Services = {
    Players = game:GetService("Players"),
    RunService = game:GetService("RunService")
}
local Player = Services.Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- Конфигурация
local ESP_CONFIG = {
    Enabled = true,
    Stage = 1, -- Начальный этаж
    MaxStage = 30,
    OrbColor = Color3.fromRGB(0, 255, 0), -- Зеленый для орбов
    TextColor = Color3.fromRGB(255, 255, 255),
    CheckInterval = 1 -- Как часто искать новые орбы (в секундах)
}

-- Кэш для хранения ESP-объектов
local ESP_CACHE = {
    Orbs = {}, -- Для отслеживания найденных орбов
    ESPHandles = {} -- Для хранения созданных BillboardGui
}

-- Функция для создания метки ESP над орбом
local function createESP(orbPart)
    if not orbPart or ESP_CACHE.ESPHandles[orbPart] then return end

    -- Создаём основу для метки (BillboardGui следует за частью в мире)
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "SWILL_OrbESP"
    billboard.Adornee = orbPart
    billboard.Size = UDim2.new(4, 0, 1, 0) -- Размер
    billboard.StudsOffset = Vector3.new(0, 3, 0) -- Над орбом
    billboard.AlwaysOnTop = true
    billboard.Enabled = ESP_CONFIG.Enabled
    billboard.MaxDistance = 150 -- Дистанция видимости
    billboard.Parent = Camera

    -- Фоновая подложка
    local frame = Instance.new("Frame")
    frame.Name = "Background"
    frame.Size = UDim2.new(1, 0, 0.3, 0)
    frame.Position = UDim2.new(0, 0, 0, 0)
    frame.BackgroundColor3 = ESP_CONFIG.OrbColor
    frame.BackgroundTransparency = 0.4
    frame.BorderSizePixel = 0
    frame.Parent = billboard

    -- Текст метки
    local label = Instance.new("TextLabel")
    label.Name = "Label"
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.TextColor3 = ESP_CONFIG.TextColor
    label.Text = "ORB"
    label.TextSize = 14
    label.Font = Enum.Font.GothamBold
    label.TextStrokeTransparency = 0.5
    label.Parent = billboard

    -- Сохраняем в кэш
    ESP_CACHE.ESPHandles[orbPart] = billboard
    ESP_CACHE.Orbs[orbPart] = true
end

-- Функция для удаления всех ESP
local function clearAllESP()
    for orbPart, handle in pairs(ESP_CACHE.ESPHandles) do
        if handle then
            handle:Destroy()
        end
    end
    ESP_CACHE.ESPHandles = {}
    ESP_CACHE.Orbs = {}
end

-- Основная функция поиска и создания ESP для орбов на текущем этаже
local function updateESPForStage()
    if not ESP_CONFIG.Enabled then return end

    clearAllESP() -- Сначала очищаем старые метки

    -- Пытаемся найти папку с орбами для текущего этажа (логика из оригинального скрипта)
    local Boosts = workspace:WaitForChild("Map"):WaitForChild("Stages"):WaitForChild("Boosts")
    local StageFolder = Boosts:FindFirstChild(tostring(ESP_CONFIG.Stage))

    if not StageFolder then
        warn("[SWILL ESP] Не найдена папка для этажа", ESP_CONFIG.Stage)
        return
    end

    -- Рекурсивно ищем все BasePart (орбы) в папке этажа
    for _, model in ipairs(StageFolder:GetChildren()) do
        for _, descendant in ipairs(model:GetDescendants()) do
            if descendant:IsA("BasePart") then
                createESP(descendant)
            end
        end
    end
    print("[SWILL ESP] Обновлено. Этаж:", ESP_CONFIG.Stage, "Найдено орбов:", #StageFolder:GetChildren())
end

-- Создаём простой интерфейс для управления
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "SWILL_ESP_Control"
screenGui.Parent = game:GetService("CoreGui")
screenGui.ResetOnSpawn = false

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 220, 0, 110)
mainFrame.Position = UDim2.new(0.1, 10, 0.1, 10)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
mainFrame.BackgroundTransparency = 0.2
mainFrame.Parent = screenGui

local title = Instance.new("TextLabel")
title.Text = "SWILL Orb ESP"
title.TextColor3 = Color3.fromRGB(0, 255, 127)
title.Size = UDim2.new(1, 0, 0, 25)
title.BackgroundTransparency = 1
title.Parent = mainFrame

local stageLabel = Instance.new("TextLabel")
stageLabel.Text = "Этаж: " .. ESP_CONFIG.Stage
stageLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
stageLabel.Size = UDim2.new(0.4, 0, 0, 25)
stageLabel.Position = UDim2.new(0.05, 0, 0.3, 0)
stageLabel.BackgroundTransparency = 1
stageLabel.Parent = mainFrame

local toggleButton = Instance.new("TextButton")
toggleButton.Text = ESP_CONFIG.Enabled and "ESP: ВКЛ" or "ESP: ВЫКЛ"
toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleButton.BackgroundColor3 = ESP_CONFIG.Enabled and Color3.fromRGB(0, 180, 0) or Color3.fromRGB(180, 0, 0)
toggleButton.Size = UDim2.new(0.9, 0, 0, 30)
toggleButton.Position = UDim2.new(0.05, 0, 0.6, 0)
toggleButton.Parent = mainFrame

toggleButton.MouseButton1Click:Connect(function()
    ESP_CONFIG.Enabled = not ESP_CONFIG.Enabled
    toggleButton.Text = ESP_CONFIG.Enabled and "ESP: ВКЛ" or "ESP: ВЫКЛ"
    toggleButton.BackgroundColor3 = ESP_CONFIG.Enabled and Color3.fromRGB(0, 180, 0) or Color3.fromRGB(180, 0, 0)
    
    -- Включаем/выключаем видимость всех созданных меток
    for _, handle in pairs(ESP_CACHE.ESPHandles) do
        handle.Enabled = ESP_CONFIG.Enabled
    end
    
    if ESP_CONFIG.Enabled then
        updateESPForStage() -- Если включили, обновляем ESP
    end
end)

-- Функция для смены этажа (например, можно привязать к другим кнопкам)
local function changeStage(newStage)
    if newStage >= 1 and newStage <= ESP_CONFIG.MaxStage then
        ESP_CONFIG.Stage = newStage
        stageLabel.Text = "Этаж: " .. ESP_CONFIG.Stage
        if ESP_CONFIG.Enabled then
            updateESPForStage()
        end
    end
end

-- Запускаем периодическую проверку
task.spawn(function()
    while task.wait(ESP_CONFIG.CheckInterval) do
        if ESP_CONFIG.Enabled then
            updateESPForStage()
        end
    end
end)

-- Автоматическое удаление ESP, если орб был собран или удалён
game:GetService("RunService").Heartbeat:Connect(function()
    for orbPart in pairs(ESP_CACHE.ESPHandles) do
        if not orbPart or not orbPart.Parent or not orbPart:IsDescendantOf(workspace) then
            if ESP_CACHE.ESPHandles[orbPart] then
                ESP_CACHE.ESPHandles[orbPart]:Destroy()
            end
            ESP_CACHE.ESPHandles[orbPart] = nil
            ESP_CACHE.Orbs[orbPart] = nil
        end
    end
end)

-- Первоначальный запуск
updateESPForStage()
print("[SWILL ESP] Система ESP для орбов инициализирована. Управление на экране.")
